name: Build Static Mosh (Final Fix)

on: 
  workflow_dispatch:

jobs:
  build-static-src-only:
    runs-on: ubuntu-latest
    name: Build Static Binary
    
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build inside Alpine Container
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:latest
          # 模拟 ARM64
          options: --platform linux/arm64 -v ${{ github.workspace }}:/work -w /work
          run: |
            echo ">>> 1. 安装构建依赖 <<<"
            apk update
            # 安装基础工具
            apk add build-base git automake autoconf libtool pkgconf \
                    protobuf-dev protobuf \
                    ncurses-dev ncurses-static \
                    openssl-dev openssl-libs-static \
                    zlib-dev zlib-static \
                    linux-headers

            echo ">>> 2. 获取源码 <<<"
            rm -rf mosh
            git clone --depth 1 https://github.com/mobile-shell/mosh.git
            cd mosh
            
            echo ">>> 3. 修改超时时间 <<<"
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            echo ">>> 4. 配置全静态编译 <<<"
            ./autogen.sh
            
            # 强制静态链接
            export CXXFLAGS="-static -O2"
            export LDFLAGS="-static"
            
            ./configure \
                --enable-static-protobuf \
                --without-utempter \
                PKG_CONFIG="pkg-config --static"
            
            echo ">>> 5. 编译 SRC 目录 (跳过 scripts) <<<"
            # 【核心修正】
            # 不要直接 make (会编译 scripts 导致 Perl 报错)
            # 也不要进 frontend (会导致缺依赖)
            # 而是编译整个 src 目录！这里面包含了 crypto, network, protobufs 等所有 C++ 库
            make -C src -j$(nproc)
            
            echo ">>> 6. 验证结果 <<<"
            # 此时文件应该在 src/frontend/ 下
            TARGET_FILE="src/frontend/mosh-server"
            
            if [ -f "$TARGET_FILE" ]; then
                echo "构建成功！"
                ls -lh "$TARGET_FILE"
                # 必须是 statically linked
                file "$TARGET_FILE"
                # 必须不是 dynamic executable
                ldd "$TARGET_FILE" || echo "验证完美：无动态库依赖"
            else
                echo "错误：文件未生成！"
                exit 1
            fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-static-arm64
          path: mosh/src/frontend/mosh-server
