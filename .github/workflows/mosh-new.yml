name: Build Mosh for ARM64 (Kylin) - Fixed

on: 
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    name: Build on aarch64
    
    steps:
      - uses: actions/checkout@v3

      # 使用专门的跨架构运行插件
      - uses: uraimo/run-on-arch-action@v2
        name: Compile inside ARM64 container
        id: build
        with:
          # 指定目标架构为 aarch64 (即 ARM64)
          arch: aarch64
          # 指定系统为 Ubuntu 20.04 (兼容麒麟 V10)
          distro: ubuntu20.04
          
          # 挂载源代码目录
          githubToken: ${{ github.token }}

          # 在这里编写编译脚本
          run: |
            echo "正在初始化 ARM64 环境..."
            
            # 1. 安装依赖
            apt-get update
            apt-get install -y build-essential automake libtool libprotobuf-dev protobuf-compiler libncurses5-dev zlib1g-dev libssl-dev pkg-config git
            
            echo "依赖安装完毕，开始修改源码..."
            
            # 2. 修改源码 (将 60秒 改为 600秒/10分钟)
            # 这里的路径不需要加 src/frontend/ 因为我们就在根目录下
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            echo "源码修改完毕，开始编译..."
            
            # 3. 编译
            ./autogen.sh
            ./configure
            make -j$(nproc)
            
            echo "编译成功！"

      # 上传编译好的文件
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-arm64
          path: src/frontend/mosh-server
