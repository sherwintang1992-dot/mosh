name: Build Static Mosh-Server ONLY (Alpine Fix)

on: 
  workflow_dispatch:

jobs:
  build-server-only:
    runs-on: ubuntu-latest
    name: Build Static Server
    
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build inside Alpine Container
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:latest
          # 模拟 ARM64 架构
          options: --platform linux/arm64 -v ${{ github.workspace }}:/work -w /work
          run: |
            echo ">>> 1. 安装编译依赖 (Alpine) <<<"
            apk update
            # 只需要 C++ 编译环境和静态库，不需要完整的 Perl
            apk add build-base git automake autoconf libtool pkgconf \
                    protobuf-dev protobuf \
                    ncurses-dev ncurses-static \
                    openssl-dev openssl-libs-static \
                    zlib-dev zlib-static \
                    linux-headers

            echo ">>> 2. 获取源码 <<<"
            rm -rf mosh
            git clone --depth 1 https://github.com/mobile-shell/mosh.git
            cd mosh
            
            echo ">>> 3. 修改超时时间 <<<"
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            echo ">>> 4. 配置环境 <<<"
            ./autogen.sh
            
            # 【核武器】全静态链接参数
            export CXXFLAGS="-static -O2"
            export LDFLAGS="-static"
            
            ./configure \
                --enable-static-protobuf \
                --without-utempter \
                PKG_CONFIG="pkg-config --static"
            
            echo ">>> 5. 只编译 mosh-server (跳过 Perl 报错) <<<"
            # 关键修改：直接进入 frontend 目录，只编译 mosh-server
            # 这样就完全避开了 scripts 目录下的 Perl 错误
            cd src/frontend
            make -j$(nproc) mosh-server
            
            echo ">>> 6. 验证 <<<"
            if [ -f mosh-server ]; then
                echo "构建成功！"
                ls -lh mosh-server
                # 必须显示 not a dynamic executable
                ldd mosh-server || echo "验证通过：全静态文件！"
            else
                echo "严重错误：文件未生成"
                exit 1
            fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-static-arm64
          # 注意路径：我们在 src/frontend 下编译的
          path: mosh/src/frontend/mosh-server
