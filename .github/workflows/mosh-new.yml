name: Build Fully Static Mosh (Alpine/ARM64)

on: 
  workflow_dispatch:

jobs:
  build-fully-static:
    runs-on: ubuntu-latest
    name: Build Static Binary
    
    steps:
      - uses: actions/checkout@v3

      # 1. 开启 QEMU 模拟器
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. 使用 Alpine Linux 进行全静态编译
      - name: Build inside Alpine Container
        uses: addnab/docker-run-action@v3
        with:
          # 使用 Alpine，因为它支持完美的静态编译
          image: arm64v8/alpine:latest
          options: -v ${{ github.workspace }}:/work -w /work
          run: |
            echo ">>> 1. 安装构建依赖 (静态库) <<<"
            # 安装编译工具和所有必要的静态库 (.a 文件)
            # Alpine 的包管理非常干净，*-static 包就是我们要的
            apk update
            apk add build-base git automake autoconf libtool pkgconf \
                    protobuf-dev protobuf \
                    ncurses-dev ncurses-static \
                    openssl-dev openssl-libs-static \
                    zlib-dev zlib-static \
                    linux-headers
            
            echo ">>> 2. 准备源码 <<<"
            # 60秒 -> 600秒 修改
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            ./autogen.sh
            
            echo ">>> 3. 配置全静态编译 <<<"
            # 关键参数解释：
            # LDFLAGS="-static": 告诉编译器，不要用 .so，全部把代码塞进二进制文件里
            # PKG_CONFIG="pkg-config --static": 告诉 pkg-config 查找库时，要把库的底层依赖也找出来
            export CXXFLAGS="-static -O2"
            export LDFLAGS="-static"
            
            ./configure \
                --enable-static-protobuf \
                --without-utempter \
                PKG_CONFIG="pkg-config --static"
            
            echo ">>> 4. 开始编译 <<<"
            make -j$(nproc)
            
            echo ">>> 5. 验证是否为纯静态 <<<"
            # 如果成功，file 命令应该显示 "statically linked"
            # ldd 命令应该报错说 "not a dynamic executable"
            file src/frontend/mosh-server
            ldd src/frontend/mosh-server 2>&1 | grep "not a dynamic executable" && echo "验证通过：是全静态文件！" || echo "警告：可能不是全静态"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-fully-static-arm64
          path: src/frontend/mosh-server
