name: Build Fully Static Mosh (Alpine ARM64 Fixed)

on: 
  workflow_dispatch:

jobs:
  build-static-final:
    runs-on: ubuntu-latest
    name: Build Static Binary
    
    steps:
      - uses: actions/checkout@v3

      # 1. 必须先注册 QEMU 模拟器
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. 运行 Docker 容器
      - name: Build inside Alpine Container
        uses: addnab/docker-run-action@v3
        with:
          # 使用官方标准 Alpine 镜像
          image: alpine:latest
          # 【关键修正】这里加上 --platform linux/arm64
          # 这告诉 Docker：虽然我在 x86 机器上，但我要你拉取并运行 ARM64 版本的 Alpine
          options: --platform linux/arm64 -v ${{ github.workspace }}:/work -w /work
          run: |
            echo ">>> 1. 检查当前架构 (必须是 aarch64) <<<"
            uname -m
            
            echo ">>> 2. 安装全静态编译依赖 <<<"
            # Alpine 的优势：apk add xxx-static 就能直接拿到静态库
            apk update
            apk add build-base git automake autoconf libtool pkgconf \
                    protobuf-dev protobuf \
                    ncurses-dev ncurses-static \
                    openssl-dev openssl-libs-static \
                    zlib-dev zlib-static \
                    linux-headers
            
            echo ">>> 3. 准备源码 <<<"
            # 修改超时限制 60s -> 600s
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            ./autogen.sh
            
            echo ">>> 4. 配置【强制全静态】 <<<"
            # LDFLAGS="-static" 是核武器，它禁止使用任何 .so 动态库
            # 所有代码都会被塞进最终的一个文件里
            export CXXFLAGS="-static -O2"
            export LDFLAGS="-static"
            
            ./configure \
                --enable-static-protobuf \
                --without-utempter \
                PKG_CONFIG="pkg-config --static"
            
            echo ">>> 5. 开始编译 <<<"
            make -j$(nproc)
            
            echo ">>> 6. 最终验证 <<<"
            echo "文件信息："
            file src/frontend/mosh-server
            
            echo "依赖检查 (应该报错说不是动态文件)："
            ldd src/frontend/mosh-server || echo "完美！ldd 无法读取，说明没有任何动态依赖！"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-static-arm64-final
          path: src/frontend/mosh-server
