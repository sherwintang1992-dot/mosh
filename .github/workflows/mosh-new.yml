name: Build Static Mosh (Root Make Fix)

on: 
  workflow_dispatch:

jobs:
  build-static-absolute:
    runs-on: ubuntu-latest
    name: Build Static Binary
    
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build inside Alpine Container
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:latest
          options: --platform linux/arm64 -v ${{ github.workspace }}:/work -w /work
          run: |
            echo ">>> 1. å‡†å¤‡ç¯å¢ƒ (Alpine ARM64) <<<"
            apk update
            apk add build-base git automake autoconf libtool pkgconf \
                    protobuf-dev protobuf \
                    ncurses-dev ncurses-static \
                    openssl-dev openssl-libs-static \
                    zlib-dev zlib-static \
                    linux-headers

            echo ">>> 2. ä¸‹è½½ Mosh æºç  <<<"
            rm -rf mosh
            git clone --depth 1 https://github.com/mobile-shell/mosh.git
            cd mosh
            
            echo ">>> 3. æ‰‹åŠ¨ç”Ÿæˆç‰ˆæœ¬æ–‡ä»¶ (é˜²æ­¢ä¾èµ–ä¸¢å¤±) <<<"
            # è¿™ä¸€æ­¥æ‰‹åŠ¨åˆ›å»º VERSION.stampï¼Œå½»åº•æœç» "No rule to make target" é”™è¯¯
            ./gen-version.sh > VERSION.stamp
            cat VERSION.stamp
            
            echo ">>> 4. é˜‰å‰²æ„å»ºåˆ—è¡¨ (å‰”é™¤ Perl è„šæœ¬) <<<"
            # ä¿®æ”¹ Makefile.amï¼Œåªä¿ç•™ src ç›®å½•
            # è¿™æ · make å°±ä¸ä¼šå»ç¼–è¯‘ scripts(Perl) å’Œ man(æ–‡æ¡£)
            sed -i 's/SUBDIRS = src scripts man/SUBDIRS = src/g' Makefile.am
            sed -i 's/SUBDIRS = .*/SUBDIRS = src/g' Makefile.am
            
            echo ">>> 5. ä¿®æ”¹è¶…æ—¶æ—¶é—´ <<<"
            sed -i 's/now - start_time > 60000/now - start_time > 600000/g' src/frontend/mosh-server.cc
            
            echo ">>> 6. é…ç½®ç¯å¢ƒ (å…¨é™æ€) <<<"
            ./autogen.sh
            
            export CXXFLAGS="-static -O2"
            export LDFLAGS="-static"
            
            ./configure \
                --enable-static-protobuf \
                --without-utempter \
                PKG_CONFIG="pkg-config --static"
            
            echo ">>> 7. å¼€å§‹ç¼–è¯‘ (ä»æ ¹ç›®å½•) <<<"
            # å› ä¸ºæˆ‘ä»¬åœ¨ç¬¬4æ­¥ä¿®æ”¹äº† SUBDIRSï¼Œè¿™é‡Œ make åªä¼šç¼–è¯‘ srcï¼Œä¸ä¼šæŠ¥é”™
            make -j$(nproc)
            
            echo ">>> 8. éªŒè¯äº§ç‰© <<<"
            TARGET="src/frontend/mosh-server"
            
            if [ -f "$TARGET" ]; then
                echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
                ls -lh "$TARGET"
                file "$TARGET"
                # å†æ¬¡ç¡®è®¤æ˜¯é™æ€æ–‡ä»¶
                if ldd "$TARGET" 2>&1 | grep -q "not a dynamic executable"; then
                     echo "ğŸ† å®Œç¾ï¼šæ–‡ä»¶æ˜¯å…¨é™æ€çš„ (Fully Static)"
                else
                     echo "âš ï¸ è­¦å‘Šï¼šå‘ç°åŠ¨æ€ä¾èµ–"
                     ldd "$TARGET"
                fi
            else
                echo "âŒ å¤±è´¥ï¼šæ–‡ä»¶æœªç”Ÿæˆ"
                exit 1
            fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosh-server-static-arm64-stable
          path: mosh/src/frontend/mosh-server
